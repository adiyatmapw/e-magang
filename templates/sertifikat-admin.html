<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Data Peserta Magang</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Figtree:wght@400;600&display=swap" rel="stylesheet" />
  <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
  <style>
    body {
      font-family: 'Figtree', sans-serif;
      margin-bottom: 2rem;
    }
    .header-image {
        background: url('{{ url_for('static', filename='images/header3.png') }}') center center / cover no-repeat;
        background-size: 100%;
        height: 200px;
        max-width: 100%;
        opacity: 0.8;
        border-radius: 10px;
        margin-bottom: 30px;
        position: relative;
    }
    .filter-card {
      margin-bottom: 1.5rem;
    }
    .btn-filter {
      border-radius: 25px;
    }
    .dataTables_wrapper .dataTables_filter {
      display: none;
    }
    thead th {
        text-align: center !important;
        vertical-align: middle !important;
    }
    #tabel-aktif thead th {
        text-align: center !important;
        vertical-align: middle !important;
    }
    #tabel-selesai thead th {
        text-align: center !important;
        vertical-align: middle !important;
    }
    .table thead th {
        vertical-align: middle;
        text-align: center;
    }
    .table tbody td {
        vertical-align: middle;
        text-align: center;
    }
    .copyright {
        margin-top: 50px;
        text-align: center;
        font-size: 14px;
        color: #666;
    }
    .filter-header {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .filter-header .label {
        font-family: 'Figtree', sans-serif;
        font-weight: 600;
        margin-bottom: 4px;
    }
    .status-tag {
        padding: 5px 10px;
        border-radius: 10px;
        font-size: 12px;
        font-weight: bold;
        color: white;
        display: inline-block;
        white-space: nowrap; /* mencegah teks terpotong ke baris berikutnya */
        max-width: 180px;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .status-sedang-diproses { background-color: #fd7e14; }
    .status-revisi-laporan { background-color: #dc3545; }
    .status-revisi-diproses { background-color: #ff3700; }
    .status-tanggal-presentasi { background-color: #28a745; }
    .status-presentasi { background-color: #6f42c1; }
    .status-menunggu-sertifikat { background-color: #ffc107; color: black; }
    .status-sertifikat { background-color: #5154EB; }

  </style>
</head>
<body>
  {% include 'navbar-admin.html' %}
{% include 'partials/flash_message.html' %}
  <div class="container-fluid">
    <div class="header-image"></div>
</div>

    <div class="container">
    <h4>Data Sertifikat Peserta </h4>

    <div class="card filter-card">
      <div class="card-header bg-secondary text-white" data-bs-toggle="collapse" data-bs-target="#filterPanel" style="cursor: pointer;">
        Filter Data <span class="float-end"><i class="bi bi-chevron-down"></i></span>
      </div>
      <div id="filterPanel" class="collapse card-body bg-light">
        <form id="filterForm" class="row g-3">
          <div class="col-md-6 col-lg-3">
            <label class="form-label">Nama</label>
            <input type="text" class="form-control" name="nama" />
          </div>
          <div class="col-md-6 col-lg-3">
            <label class="form-label">Email</label>
            <input type="text" class="form-control" name="email" />
          </div>
          <div class="col-md-6 col-lg-3">
            <label class="form-label">Asal Kampus</label>
            <input type="text" class="form-control" name="kampus" />
          </div>
          <div class="col-md-6 col-lg-3">
            <label class="form-label">Divisi</label>
            <input type="text" class="form-control" name="nama_divisi" />
          </div>
          <div class="col-md-6 col-lg-3">
            <label class="form-label">Status Laporan</label>
            <select class="form-select" name="status_laporan">
              <option value="">Semua</option>
              <option value="Sedang Diproses">Sedang Diproses</option>
              <option value="Revisi Laporan">Revisi Laporan</option>
              <option value="Revisi Sedang Diproses">Revisi Sedang Diproses</option>
              <option value="Tentukan Tanggal Presentasi">Tentukan Tanggal Presentasi</option>
              <option value="Presentasi">Presentasi</option>
              <option value="Menunggu Sertifikat">Menunggu Sertifikat</option>
              <option value="Sertifikat Tercetak">Sertifikat Tercetak</option>
            </select>
          </div>
          <div class="col-md-6 col-lg-3">
            <label class="form-label">Tanggal Aktivitas</label>
            <input type="date" class="form-control" name="last_activity" />
          </div>
          <div class="col-md-6 col-lg-3">
            <label class="form-label">Waktu Tunggu (hari)</label>
            <input type="number" class="form-control" name="waktu_tunggu" />
          </div>
          <div class="col-12">
            <button type="submit" class="btn btn-primary btn-filter">Filter</button>
          </div>
        </form>
      </div>
    </div>

    <h5>Data Peserta Aktif</h5>
    <table id="tabel-peserta" class="table table-striped table-bordered table-hover" style="width:100%">
      <thead>
        <tr>
          <th>No</th>
          <th>Nama</th>
          <th>Email</th>
          <th>Asal Kampus</th>
          <th>Divisi</th>
          <th>Status Laporan</th>
          <th>Tanggal Aktivitas</th>
          <th>Waktu Tunggu</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for p in data_peserta %}
        <tr>
          <td class="text-center">{{ loop.index }}</td>
          <td>{{ p.nama }}</td>
          <td>{{ p.email }}</td>
          <td>{{ p.asal_kampus }}</td>
          <td>{{ p.nama_divisi or '-' }}</td>
          <td>               
            <span class="status-tag 
                {% if p.status_laporan_magang == 'Sedang Diproses' %} status-sedang-diproses
                {% elif p.status_laporan_magang == 'Revisi Laporan' %} status-revisi-laporan
                {% elif p.status_laporan_magang == 'Revisi Sedang Diproses' %} status-revisi-diproses
                {% elif p.status_laporan_magang == 'Tentukan Tanggal Presentasi' %} status-tanggal-presentasi
                {% elif p.status_laporan_magang == 'Presentasi' %} status-presentasi
                {% elif p.status_laporan_magang == 'Menunggu Sertifikat' %} status-menunggu-sertifikat
                {% elif p.status_laporan_magang == 'Sertifikat Tercetak' %} status-sertifikat
                {% endif %}">
                {{ p.status_laporan_magang or '-' }}
            </span>
            </td>
            <td>{{ p.last_activity.strftime('%d-%m-%Y %H:%M') if p.last_activity else '-' }}</td>
            <td>{{ p.waktu_tunggu }} hari</td>
          <td class="text-center">
            {% if p.status_laporan_magang == 'Menunggu Sertifikat' %}
              <a href="{{ url_for('review_sertifikat', id=p.id) }}" class="btn btn-success btn-sm"><i class="bi bi-award"></i></a>
            {% elif p.status_laporan_magang == 'Sertifikat Tercetak' %}
              <button class="btn btn-primary btn-sm disabled"><i class="bi bi-award"></i></button>
              {% else %}
              <a href="{{ url_for('review_laporanakhir', id=p.id) }}" class="btn btn-warning btn-sm"><i class="bi bi-eye"></i></a>
            {% endif %}            
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    $(document).ready(function () {
      const table = $('#tabel-peserta').DataTable({
        paging: true,
        searching: true,
        lengthChange: true,
        order: [
          [6, 'asc']
        ],
        columnDefs: [{
          orderable: false,
          targets: [8]
        }]
      });

      $('#filterForm').on('submit', function (e) {
        e.preventDefault();

        const nama = $('input[name="nama"]').val();
        const email = $('input[name="email"]').val();
        const kampus = $('input[name="kampus"]').val();
        const divisi = $('input[name="nama_divisi"]').val();
        const status_laporan = $('select[name="status_laporan"]').val();
        const last_activity = $('input[name="last_activity"]').val();
        const waktu_tunggu = parseInt($('input[name="waktu_tunggu"]').val());

        table
          .column(1).search(nama)
          .column(2).search(email)
          .column(3).search(kampus)
          .column(4).search(divisi)
          .column(5).search(status_laporan)
          .draw();

        table.rows().every(function () {
          const row = $(this.node());
          let show = true;

          if (last_activity) {
            const val = row.find('td').eq(6).text().trim();
            if (val !== '-') {
              const rowDate = moment(val, 'DD-MM-YYYY HH:mm');
              const filterDate = moment(last_activity);
              if (!rowDate.isSame(filterDate, 'day')) {
                show = false;
              }
            } else {
              show = false;
            }
          }

          if (!isNaN(waktu_tunggu)) {
            const tunggu = row.find('td').eq(7).text().replace(' hari', '').trim();
            if (parseInt(tunggu) < waktu_tunggu) {
              show = false;
            }
          }

          row.toggle(show);
        });
      });
    });
  </script>
</body>
</html>
